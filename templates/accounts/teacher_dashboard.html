<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Teacher Dashboard - DMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: linear-gradient(135deg,#f8fafc 0,#eef2ff 100%); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hero { padding: 28px 0; }
        .card-compact { border-radius: 12px; box-shadow: 0 6px 18px rgba(44,62,80,0.08); }
        .welcome { font-weight:700; }
        .small-muted { color:#6c757d; font-size:0.9rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">DMS</a>
            <div class="ms-auto">
                <span class="me-3 small-muted">Signed in as <strong>{{ request.user.get_full_name|default:request.user.username }}</strong></span>
                <a href="/accounts/logout/" class="btn btn-outline-secondary btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container hero">
        <div class="row align-items-center mb-3">
            <div class="col-md-8">
                <h2 class="welcome">Good day, {{ request.user.first_name|default:request.user.username }} ðŸ‘‹</h2>
                <p class="small-muted">Teacher dashboard â€” quick access to your reports and students.</p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a href="/reports/" class="btn btn-outline-primary px-4"><i class="fas fa-file-alt me-2"></i>My Reports</a>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-lg-3 col-md-6">
                <div class="card card-compact p-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3 text-primary"><i class="fas fa-file-alt fa-2x"></i></div>
                        <div>
                            <div class="small-muted">My Reports</div>
                            <div class="h3 mb-0">{{ total_reports_count|default:"0" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card card-compact p-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3 text-success"><i class="fas fa-check-circle fa-2x"></i></div>
                        <div>
                            <div class="small-muted">Pending Reports</div>
                            <div class="h3 mb-0">{{ pending_reports_count|default:"0" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card card-compact p-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3 text-warning"><i class="fas fa-user-graduate fa-2x"></i></div>
                        <div>
                            <div class="small-muted">My Students</div>
                            <div class="h3 mb-0" id="total-students">{{ total_students|default:"0" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card card-compact p-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3 text-info"><i class="fas fa-chart-line fa-2x"></i></div>
                        <div>
                            <div class="small-muted">Total Reports</div>
                            <div class="h5" id="teacher-stream">{{ teacher_profile.stream|default:"No stream assigned" }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="row mt-4">
            <div class="col-lg-5">
                <div class="card p-3 card-compact mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">My Students ({{ teacher_profile.get_stream_display|default:"No Stream" }})</h5>
                        <span class="badge bg-primary rounded-pill">{{ students|length }}</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Admission</th>
                                    <th>Gender</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr>
                                    <td>
                                        {% if student.profile_picture %}
                                        <img src="{{ student.profile_picture.url }}" alt="{{ student.name }}" class="rounded-circle me-2" width="30" height="30">
                                        {% else %}
                                        <div class="d-inline-flex align-items-center justify-content-center bg-light rounded-circle me-2" style="width: 30px; height: 30px;">
                                            <i class="fas fa-user text-muted"></i>
                                        </div>
                                        {% endif %}
                                        {{ student.name }}
                                    </td>
                                    <td>{{ student.admission_number }}</td>
                                    <td>{{ student.get_gender_display }}</td>
                                    <td class="text-end">
                                        <a href="{% url 'reports:create-report' %}?student_id={{ student.id }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-file-alt me-1"></i> Report
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">
                                        {% if teacher_profile and not teacher_profile.stream %}
                                        No stream assigned to your profile. Please contact administrator.
                                        {% else %}
                                        No students found in your stream.
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-7">
                <div class="card p-3 card-compact">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Recent Reports</h5>
                        <a href="/reports/" class="small-muted">View all</a>
                    </div>
                    <div>
                        <ul class="list-group list-group-flush">
                            {% if recent_reports %}
                                {% for r in recent_reports %}
                                    <li class="list-group-item d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-semibold">{{ r.student.name }}</div>
                                            <div class="small-muted">{{ r.category }} â€” {{ r.created_at|date:"M j, Y H:i" }}</div>
                                        </div>
                                        <div>
                                            {% if r.status|lower == 'pending' %}
                                                <span class="badge bg-warning text-dark">{{ r.status }}</span>
                                                <div class="d-flex justify-content-between align-items-center">
                                                   
                                                </div>
                                            {% elif r.status|lower == 'rejected' %}
                                                <span class="badge bg-danger">{{ r.status }}</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ r.status }}</span>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% endfor %}
                            {% else %}
                                <li class="list-group-item text-center small-muted">No recent reports</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card p-3 card-compact">
                    <h5 class="mb-3">Reports by Category</h5>
                    <div style="height:320px;">
                        <canvas id="teacherCatChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to update the dashboard data
        function updateDashboard() {
            fetch('/accounts/api/teacher/dashboard/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }

                    // Update reports today counter
                    const reportsTodayElement = document.getElementById('reports-today');
                    if (reportsTodayElement) {
                        reportsTodayElement.textContent = data.total_reports_today;
                        // Add animation
                        reportsTodayElement.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            reportsTodayElement.style.transform = 'scale(1)';
                        }, 300);
                    }

                    // Update total students
                    const totalStudentsElement = document.getElementById('total-students');
                    if (totalStudentsElement) {
                        totalStudentsElement.textContent = data.total_students;
                    }

                    // Update recent reports table
                    const recentReportsBody = document.getElementById('recent-reports-body');
                    if (recentReportsBody) {
                        recentReportsBody.innerHTML = ''; // Clear existing rows
                        
                        if (data.recent_reports && data.recent_reports.length > 0) {
                            data.recent_reports.forEach(report => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${report.student__name || 'N/A'}</td>
                                    <td>${report.category || 'N/A'}</td>
                                    <td><span class="badge bg-${getStatusBadgeClass(report.status)}">${report.status || 'N/A'}</span></td>
                                    <td>${report.created_at || 'N/A'}</td>
                                    <td class="text-end">
                                        <a href="/reports/report/${report.id}/" class="btn btn-sm btn-outline-primary">View</a>
                                    </td>
                                `;
                                recentReportsBody.appendChild(row);
                            });
                        } else {
                            const row = document.createElement('tr');
                            row.innerHTML = '<td colspan="5" class="text-center">No recent reports found</td>';
                            recentReportsBody.appendChild(row);
                        }
                    }

                    // Update stream info if available
                    if (data.stream) {
                        const streamElement = document.getElementById('teacher-stream');
                        if (streamElement) {
                            streamElement.textContent = data.stream;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching dashboard data:', error);
                });
        }

        // Helper function to get badge class based on status
        function getStatusBadgeClass(status) {
            switch(status?.toLowerCase()) {
                case 'pending': return 'warning';
                case 'approved': return 'success';
                case 'rejected': return 'danger';
                default: return 'secondary';
            }
        }

        // Update dashboard immediately and then every 30 seconds
        document.addEventListener('DOMContentLoaded', function() {
            // Initial update
            updateDashboard();
            
            // Set up auto-refresh every 30 seconds
            setInterval(updateDashboard, 30000);
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                #reports-today {
                    transition: transform 0.3s ease-in-out;
                    display: inline-block;
                }
                .badge {
                    text-transform: capitalize;
                }
            `;
            document.head.appendChild(style);
        });

        // Chart data (provided by view if available)
        const categories = JSON.parse('{{ categories_json|default:'[]'|escapejs }}');
        const catValues = JSON.parse('{{ cat_values_json|default:'[]'|escapejs }}');

        new Chart(document.getElementById('teacherCatChart'), {
            type: 'doughnut',
            data: {
                labels: categories.length ? categories : ['No data'],
                datasets: [{ data: catValues.length ? catValues : [1], backgroundColor: ['#667eea','#764ba2','#4ecdc4','#ff6b6b'] }]
            },
            options: { responsive:true, maintainAspectRatio:false }
        });
    </script>
</body>
</html>
