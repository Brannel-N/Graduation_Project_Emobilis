{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Profile - DMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .profile-card { max-width: 920px; margin: 28px auto; }
      .avatar-lg { width:140px; height:140px; border-radius:12px; object-fit:cover; border:4px solid rgba(0,0,0,0.06); }
      .avatar-placeholder { width:140px; height:140px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:48px; font-weight:700; color:#fff; background:linear-gradient(135deg,#667eea,#764ba2); }
      .card-header-hero { background: linear-gradient(90deg,#667eea,#764ba2); color: #fff; border-top-left-radius: .375rem; border-top-right-radius: .375rem; }
      .file-input-label { display:inline-block; }
      .note { font-size:0.9rem; color:#6b7280; }
    </style>
  </head>
  <body>
    <div class="container profile-card">
      <div class="card shadow-sm">
        <div class="card-header card-header-hero py-3 px-4 d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">My Profile</h4>
            <small class="text-white-50">Manage your account and profile picture</small>
          </div>
          <div>
            <a href="{% url 'teacher-dashboard' %}" class="btn btn-light btn-sm">Back to Dashboard</a>
          </div>
        </div>

        <div class="card-body p-4">
          <div class="row g-4">
            <div class="col-md-4 text-center">
              {% if existing_url or user_profile_picture %}
                <img id="avatarPreview" src="{{ existing_url|default:user_profile_picture }}" alt="avatar" class="avatar-lg mb-3">
              {% else %}
                <div id="avatarPreview" class="avatar-placeholder mb-3">{{ request.user.first_name|default:request.user.username|slice:":1"|upper }}</div>
              {% endif %}
              <div class="mb-2">
                <label class="btn btn-outline-primary btn-sm file-input-label">
                  <i class="fas fa-upload me-2"></i>Choose Photo
                  <input type="file" name="profile_picture" accept="image/*" style="display:none;" onchange="document.getElementById('fileName').textContent = this.files[0]?.name || 'No file chosen'">
                </label>
                <span id="fileName" class="ms-2 small text-muted">No file chosen</span>
                {% if form.profile_picture.errors %}
                  {% for err in form.profile_picture.errors %}
                    <div class="text-danger small mt-2">{{ err }}</div>
                  {% endfor %}
                {% endif %}
              </div>
              <div class="note">Recommended: JPG/PNG, max 15MB. Square images work best.</div>
            </div>

            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label">Name</label>
                <div class="form-control-plaintext">{{ request.user.get_full_name|default:request.user.username }}</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <div class="form-control-plaintext">{{ request.user.email }}</div>
              </div>

              <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" type="submit"><i class="fas fa-save me-2"></i>Save Profile Picture</button>
                  <a class="btn btn-outline-secondary" href="/accounts/dashboard/admin/">Cancel</a>
                </div>
              </form>
            </div>
          </div>

          {% if messages %}
            <div class="mt-4 pt-3 border-top">
              {% for message in messages %}
                <div class="alert {% if 'success' in message.tags %}alert-success{% elif 'error' in message.tags %}alert-danger{% else %}alert-info{% endif %} alert-dismissible fade show d-flex align-items-center" role="alert">
                  <i class="fas fa-check-circle me-2"></i>
                  <div>{{ message }}</div>
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Client-side preview for chosen file
      (function(){
        const fileInput = document.querySelector('input[type="file"][name="profile_picture"]');
        const preview = document.getElementById('avatarPreview');
        const fileName = document.getElementById('fileName');
        if (!fileInput) return;
        
        fileInput.addEventListener('change', function(e){
          const f = e.target.files[0];
          if (!f) {
            fileName.textContent = 'No file chosen';
            return;
          }
          // Update file name display
          fileName.textContent = f.name;
          
          // Show preview
          const reader = new FileReader();
          reader.onload = function(ev){
            if (preview.tagName === 'IMG') {
              preview.src = ev.target.result;
            } else {
              // replace placeholder div with img
              const img = document.createElement('img');
              img.id = 'avatarPreview';
              img.className = 'avatar-lg mb-3';
              img.src = ev.target.result;
              preview.replaceWith(img);
            }
          };
          reader.readAsDataURL(f);
        });
      })();
    </script>
  </body>
</html>